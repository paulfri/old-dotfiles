#!/usr/bin/env bash

#############################################################
# setup
#
# Install or update system components based on my dotfiles.
# https://github.com/paulfri/dotfiles
#
# Should run idempotently, so run both for installing and
# updating.
#############################################################

set -e

DOTFILES="$HOME/src/dotfiles"
CHRUBY_DIR='/usr/local/share/chruby'
RUBY_VERSION="ruby-$(cat .ruby-version)"
HOMEBREW_URL='https://raw.githubusercontent.com/Homebrew/install/master/install'
SYMLINKS="
bin
etc
.gemrc
.gitconfig
.tmux.conf
.zshrc
paulfri.zsh-theme"

# --- macOS preferences
defaults write com.apple.screencapture disable-shadow -bool true
defaults write com.apple.finder AppleShowAllFiles -bool true
chflags nohidden $HOME/Library
killall Finder

# --- symlinks
cd $HOME
mkdir -p .config/nvim || true
ln -s "$DOTFILES/.config/nvim/init.vim" "$HOME/.config/nvim" || true

for link in $SYMLINKS; do
  if [ -L "$HOME/$link" ]; then
    echo "Link '$link' already exists"
  else
    ln -s "src/dotfiles/$link" .
  fi
done

# --- homebrew installation and packages
if command -v brew; then
  brew update
else
  /usr/bin/ruby -e "$(curl -fsSL $HOMEBREW_URL)"
fi

cd $HOME/etc && brew bundle && brew cleanup

# --- ruby installation
source $CHRUBY_DIR/chruby.sh
chruby $RUBY_VERSION || ruby-install --cleanup $RUBY_VERSION
gem update --system
gem install bundler

# --- python updates
pip install --upgrade pip setuptools
pip3 install --upgrade pip setuptools
